<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šæ™ºèƒ½åŠ©æ‰‹</title>
    <!-- å¼•å…¥ Poppins å­—ä½“å’Œ Font Awesome å›¾æ ‡ -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #3a7bd5;
            --primary-dark: #2a5db0;
            --secondary-color: #00d2ff;
            --background-start: #a8c0ff;
            --background-end: #3f2b96;
            --chat-bg: #f8f9fa;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-attachment: fixed;
        }

        .main-layout {
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            background-color: rgba(255, 255, 255, 0.98);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            transition: all 0.5s ease;
        }

        .contacts-panel {
            width: 250px;
            min-width: 250px;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .contacts-header {
            padding: 20px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #374151;
            border-bottom: 1px solid #e0e0e0;
        }

        .contact-search {
            padding: 15px 10px;
        }

        .contact-search input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            background-color: #f9fafb;
            font-size: 0.9rem;
        }

        .contact-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 10px 10px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .contact-item:hover {
            background-color: #f3f4f6;
        }

        .contact-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .contact-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .contact-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
        }

        .contact-status-text {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: auto;
            flex-shrink: 0;
        }

        .online {
            background-color: #10b981;
        }

        .offline {
            background-color: #9ca3af;
        }

        .chat-container {
            flex-grow: 1;
            min-width: 400px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--chat-bg);
        }

        .header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            padding: 20px;
            color: white;
            font-weight: 700;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .chat-title {
            flex: 1 1 180px;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
        }

        .header-actions {
            flex: 2 1 280px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
        }

        .shortcut-scroll {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 1 360px;
            max-width: clamp(220px, 35vw, 420px);
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.45) transparent;
        }

        .shortcut-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .shortcut-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 999px;
        }

        .shortcut-chip {
            flex-shrink: 0;
            border: none;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 0.85rem;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.22);
            backdrop-filter: blur(2px);
            cursor: pointer;
            transition: background-color 0.25s ease, transform 0.2s ease;
        }

        .shortcut-chip:hover,
        .shortcut-chip:focus-visible {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
            outline: none;
        }

        .shortcut-chip:active {
            transform: translateY(0);
        }

        .shortcut-select {
            display: none;
            border-radius: 999px;
            border: none;
            padding: 6px 28px 6px 12px;
            font-size: 0.9rem;
            color: var(--primary-dark);
            background: rgba(255, 255, 255, 0.85);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg fill='%232a5db0' height='24' width='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            cursor: pointer;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .header-btn:hover:not([disabled]),
        .header-btn:focus-visible {
            background-color: rgba(255, 255, 255, 0.32);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
            outline: none;
        }

        .header-btn[disabled] {
            opacity: 0.65;
            cursor: not-allowed;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            background-color: var(--chat-bg);
            padding: 20px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) #e5e7eb;
        }

        .messages-wrapper::-webkit-scrollbar {
            width: 8px;
        }

        .messages-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.5s ease;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message img {
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            object-fit: cover;
        }

        .message-content {
            background-color: white;
            padding: 12px 18px;
            border-radius: 20px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.6;
            position: relative;
        }

        .user .message-content {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot .message-content {
            border-bottom-left-radius: 4px;
            text-align: left;
        }

        .message-time {
            display: block;
            font-size: 0.7rem;
            margin-top: 8px;
            color: rgba(0, 0, 0, 0.38);
            text-align: right;
        }

        .user .message-time {
            color: rgba(255, 255, 255, 0.7);
        }

        .bot-link {
            color: var(--primary-dark);
            font-weight: 600;
            text-decoration: none;
            border-bottom: 1px dashed transparent;
            transition: border-color 0.2s ease, color 0.2s ease;
        }

        .bot-link:hover,
        .bot-link:focus-visible {
            color: var(--primary-color);
            border-color: var(--primary-color);
            outline: none;
        }

        .typing-indicator .message-content {
            background-color: #e5e7eb;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #6b7280;
            border-radius: 50%;
            animation: dot-flashing 1.2s infinite alternate;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.4s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.8s;
        }

        .input-area {
            display: flex;
            flex-direction: column;
            padding: 15px 20px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
        }

        .media-bar {
            display: flex;
            gap: 15px;
            padding-bottom: 10px;
        }

        .media-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.3rem;
            transition: color 0.2s;
        }

        .media-btn:hover,
        .media-btn:focus-visible {
            color: var(--primary-color);
            outline: none;
        }

        .input-row {
            display: flex;
            align-items: center;
        }

        .input-row input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            background-color: #f9fafb;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-row input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
        }

        .input-row button {
            width: 50px;
            height: 50px;
            margin-left: 10px;
            border: none;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
        }

        .input-row button:hover:not([disabled]),
        .input-row button:focus-visible {
            background-color: var(--primary-dark);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            outline: none;
        }

        .input-row button[disabled] {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .command-panel {
            width: 320px;
            min-width: 320px;
            background-color: #f9fafb;
            border-left: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .command-panel h3 {
            font-size: 1.1rem;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-section {
            margin-bottom: 25px;
        }

        .feature-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #4b5563;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feature-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(58, 123, 213, 0.15);
            border-color: var(--primary-color);
        }

        .feature-card-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .feature-card-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
            margin-bottom: 6px;
        }

        .feature-card-desc {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .command-group {
            margin-bottom: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .command-item {
            padding: 8px 0;
            border-bottom: 1px dashed #f3f4f6;
            cursor: pointer;
        }

        .command-item:last-child {
            border-bottom: none;
        }

        .command-item:hover .command-name,
        .command-item:focus-visible .command-name {
            color: var(--primary-dark);
            outline: none;
        }

        .command-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.95rem;
        }

        .command-desc {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 2px;
        }

        .command-tag {
            background-color: #e0f2f1;
            color: #047857;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-right: 5px;
            font-weight: 500;
        }

        @keyframes dot-flashing {
            0% {
                opacity: 0.2;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.2;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 1200px) {
            .command-panel {
                display: none;
            }
            .main-layout {
                max-width: 900px;
            }
        }

        @media (max-width: 900px) {
            .main-layout {
                width: 100%;
                height: 100vh;
                max-width: none;
                border-radius: 0;
            }
            .contacts-panel {
                display: none;
            }
            .chat-container {
                width: 100%;
                max-width: none;
                border-radius: 0;
            }
            body {
                align-items: flex-start;
                padding-top: 0;
            }
            .header {
                border-radius: 0;
            }
        }

        @media (max-width: 700px) {
            .header {
                gap: 12px;
            }
            .header-actions {
                flex: 1 1 100%;
                justify-content: flex-start;
            }
            .shortcut-scroll {
                display: none;
            }
            .shortcut-select {
                display: inline-block;
            }
            .header-btn {
                margin-left: auto;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="contacts-panel">
            <div class="contacts-header">
                è”ç³»äºº
            </div>
            <div class="contact-search">
                <input type="text" placeholder="æœç´¢åŒäº‹..." aria-label="æœç´¢åŒäº‹">
            </div>
            <div class="contact-list" id="contactList"></div>
        </div>

        <div class="chat-container">
            <div class="header">
                <span class="chat-title">ä¼ä¸šæ™ºèƒ½åŠ©æ‰‹</span>
                <div class="header-actions">
                    <div class="shortcut-scroll" id="headerShortcuts" aria-label="å¸¸ç”¨å¿«æ·æŒ‡ä»¤"></div>
                    <select id="shortcutSelect" class="shortcut-select" aria-label="ç§»åŠ¨ç«¯å¿«æ·æŒ‡ä»¤">
                        <option value="">å¸¸ç”¨æŒ‡ä»¤â€¦</option>
                    </select>
                    <button type="button" class="header-btn" id="clearBtn" onclick="clearChat()">
                        <i class="fas fa-trash-alt" aria-hidden="true"></i>
                        <span style="margin-left:6px;">æ¸…é™¤</span>
                    </button>
                </div>
            </div>

            <div class="messages-wrapper" id="chatMessages"></div>

            <div class="input-area">
                <div class="media-bar">
                    <button class="media-btn" title="å‘é€è¡¨æƒ…åŒ…" onclick="handleMediaInput('emoji')">
                        <i class="far fa-smile"></i>
                    </button>
                    <button class="media-btn" title="å‘é€å›¾ç‰‡" onclick="handleMediaInput('image')">
                        <i class="far fa-image"></i>
                    </button>
                    <button class="media-btn" title="å‘é€è¯­éŸ³" onclick="handleMediaInput('voice')">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <div class="input-row">
                    <input type="text" id="userMessage" placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯æˆ– @å¿«æ·æŒ‡ä»¤..." autocomplete="off" aria-label="èŠå¤©è¾“å…¥">
                    <button id="sendBtn" type="button" onclick="prepareAndSendMessage()" aria-label="å‘é€">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="command-panel" id="commandPanel">
            <h3><i class="fas fa-th-large"></i> åŠŸèƒ½ä¸­å¿ƒ</h3>
            
            <!-- ä¼ä¸šåŠŸèƒ½æ¨¡å— -->
            <div class="feature-section">
                <div class="feature-section-title">
                    <i class="fas fa-building"></i> ä¼ä¸šåŠŸèƒ½
                </div>
                <div class="feature-card" onclick="openFeature('project')">
                    <span class="feature-card-icon">ğŸ“</span>
                    <div class="feature-card-title">é¡¹ç›®æ–‡ä»¶åº“</div>
                    <div class="feature-card-desc">æŸ¥çœ‹å’Œç®¡ç†é¡¹ç›®æ–‡æ¡£ã€èµ„æ–™å’Œæ–‡ä»¶å…±äº«</div>
                </div>
                <div class="feature-card" onclick="openFeature('meeting')">
                    <span class="feature-card-icon">ğŸ“…</span>
                    <div class="feature-card-title">ä¼šè®®é¢„å®š</div>
                    <div class="feature-card-desc">é¢„å®šä¼šè®®å®¤ã€æŸ¥çœ‹ä¼šè®®æ—¥ç¨‹å’Œå‚ä¼šäººå‘˜</div>
                </div>
                <div class="feature-card" onclick="openFeature('resource')">
                    <span class="feature-card-icon">ğŸ”—</span>
                    <div class="feature-card-title">èµ„æºå…±äº«</div>
                    <div class="feature-card-desc">å…±äº«èµ„æºé“¾æ¥ã€æ–‡æ¡£å’Œå·¥å…·ç»™å›¢é˜Ÿæˆå‘˜</div>
                </div>
            </div>

            <!-- å¿«æ·æŒ‡ä»¤ä¸­å¿ƒ -->
            <div class="feature-section">
                <div class="feature-section-title">
                    <i class="fas fa-bolt"></i> å¿«æ·æŒ‡ä»¤
                </div>
                <div class="command-group">
                    <div class="command-item" onclick="useCommand('@è¯·å‡')" tabindex="0">
                        <span class="command-tag">@è¯·å‡</span>
                        <span class="command-name">è¯·å‡ç”³è¯·</span>
                        <div class="command-desc">å¿«é€Ÿå‘èµ·å¹´å‡ã€ç—…å‡ç­‰ç”³è¯·æµç¨‹ã€‚</div>
                    </div>
                    <div class="command-item" onclick="useCommand('@å‡ºå·®')" tabindex="0">
                        <span class="command-tag">@å‡ºå·®</span>
                        <span class="command-name">å‡ºå·®æŠ¥å¤‡</span>
                        <div class="command-desc">ä¸€é”®å¡«å†™å‡ºå·®ç›®çš„åœ°ã€æ—¥æœŸå’Œäº‹ç”±ã€‚</div>
                    </div>
                    <div class="command-item" onclick="useCommand('@æ—¥ç¨‹')" tabindex="0">
                        <span class="command-tag">@æ—¥ç¨‹</span>
                        <span class="command-name">æ—¥ç¨‹ç®¡ç†</span>
                        <div class="command-desc">æŸ¥çœ‹ã€åˆ›å»ºå’Œä¿®æ”¹æ‚¨çš„ä¸ªäººåŠå›¢é˜Ÿæ—¥ç¨‹ã€‚</div>
                    </div>
                </div>

                <div class="command-group">
                    <div class="command-item" onclick="useCommand('@é€šè®¯å½•æŸ¥è¯¢')" tabindex="0">
                        <span class="command-tag">@é€šè®¯å½•æŸ¥è¯¢</span>
                        <span class="command-name">æŸ¥è¯¢åŒäº‹ä¿¡æ¯</span>
                        <div class="command-desc">å¿«é€ŸæŸ¥æ‰¾åŒäº‹çš„ç”µè¯ã€é‚®ç®±å’Œéƒ¨é—¨ã€‚</div>
                    </div>
                    <div class="command-item" onclick="useCommand('@é‚®ç®±')" tabindex="0">
                        <span class="command-tag">@é‚®ç®±</span>
                        <span class="command-name">é‚®ä»¶å‘é€</span>
                        <div class="command-desc">é€šè¿‡å£å¤´æŒ‡ä»¤èµ·è‰å¹¶å‘é€é‚®ä»¶ã€‚</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let userAvatar = 'https://i.pravatar.cc/150?img=1';
        let botAvatar = 'https://i.pravatar.cc/150?img=5';

        const COLLEAGUES = [
            { name: "æå (Li Hua)", status: "online", role: "é¡¹ç›®ç»ç†", img: "https://i.pravatar.cc/150?img=10" },
            { name: "å¼ æ˜ (Ming Zhang)", status: "online", role: "è½¯ä»¶å·¥ç¨‹å¸ˆ", img: "https://i.pravatar.cc/150?img=12" },
            { name: "ç‹èŠ³ (Wang Fang)", status: "offline", role: "è®¾è®¡æ€»ç›‘", img: "https://i.pravatar.cc/150?img=15" },
            { name: "èµµé›· (Lei Zhao)", status: "online", role: "äººåŠ›èµ„æº", img: "https://i.pravatar.cc/150?img=18" },
            { name: "é™ˆè–‡ (Chen Wei)", status: "offline", role: "å¸‚åœºä¸“å‘˜", img: "https://i.pravatar.cc/150?img=20" }
        ];

        const quickCommands = {
            '@è¯·å‡': '/quick/leave',
            '@leave': '/quick/leave',
            '@é€šè®¯å½•': '/quick/contact',
            '@é€šè®¯å½•æŸ¥è¯¢': '/quick/contact',
            '@contact': '/quick/contact',
            '@é‚®ç®±': '/quick/email',
            '@é‚®ä»¶': '/quick/email',
            '@email': '/quick/email',
            '@å‡ºå·®': '/quick/trip',
            '@trip': '/quick/trip',
            '@æ—¥ç¨‹': '/quick/schedule',
            '@æ—¥ç¨‹ç®¡ç†': '/quick/schedule',
            '@schedule': '/quick/schedule',
            '@calendar': '/quick/schedule'
        };

        const HEADER_SHORTCUTS = [
            { code: '@è¯·å‡', label: 'è¯·å‡ç”³è¯·' },
            { code: '@å‡ºå·®', label: 'å‡ºå·®æŠ¥å¤‡' },
            { code: '@æ—¥ç¨‹', label: 'æ—¥ç¨‹ç®¡ç†' },
            { code: '@é€šè®¯å½•æŸ¥è¯¢', label: 'æŸ¥é€šè®¯å½•' },
            { code: '@é‚®ç®±', label: 'å‘é€é‚®ä»¶' }
        ];

        const inputEl = document.getElementById('userMessage');
        const btnEl = document.getElementById('sendBtn');
        const chatMessagesContainer = document.getElementById('chatMessages');
        const contactListEl = document.getElementById('contactList');
        const headerShortcutsContainer = document.getElementById('headerShortcuts');
        const shortcutSelectEl = document.getElementById('shortcutSelect');

        let typingEl = null;

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function addMessage(sender, message, avatar, time) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            const formattedMessage = message.replace(/\n/g, '<br>');

            messageDiv.innerHTML = `
                <img src="${avatar}" alt="${sender === 'user' ? 'ç”¨æˆ·å¤´åƒ' : 'æœºå™¨äººå¤´åƒ'}" onerror="this.onerror=null;this.src='${sender === 'user' ? 'https://via.placeholder.com/40/3a7bd5/ffffff?text=U' : 'https://via.placeholder.com/40/00d2ff/ffffff?text=B'}';">
                <div class="message-content">
                    ${formattedMessage}
                    <span class="message-time">${time}</span>
                </div>
            `;
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function showTyping() {
            typingEl = document.createElement('div');
            typingEl.className = 'message bot typing-indicator';
            typingEl.innerHTML = `
                <img src="${botAvatar}" alt="æœºå™¨äººå¤´åƒ">
                <div class="message-content">
                    <span>æ­£åœ¨æ€è€ƒ</span>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <span class="message-time">${getCurrentTime()}</span>
                </div>
            `;
            chatMessagesContainer.appendChild(typingEl);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function hideTyping() {
            if (typingEl && typingEl.parentNode) {
                typingEl.parentNode.removeChild(typingEl);
            }
            typingEl = null;
        }

        function displayMessage(sender, message) {
            const avatar = sender === 'user' ? userAvatar : botAvatar;
            addMessage(sender, message, avatar, getCurrentTime());
        }

        window.clearChat = function () {
            chatMessagesContainer.innerHTML = '';
            displayInitialMessage();
        };

        function detectQuickCommand(message) {
            const trimmed = message.trim().toLowerCase();
            for (const [cmd, url] of Object.entries(quickCommands)) {
                if (trimmed === cmd.toLowerCase() || trimmed.startsWith(cmd.toLowerCase() + ' ')) {
                    return url;
                }
            }
            return null;
        }

        function renderColleagues() {
            contactListEl.innerHTML = COLLEAGUES.map(colleague => {
                const statusClass = colleague.status === 'online' ? 'online' : 'offline';
                const statusText = colleague.status === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿';
                return `
                    <div class="contact-item" onclick="startChatWithColleague('${colleague.name}')" tabindex="0">
                        <img src="${colleague.img}" alt="${colleague.name}å¤´åƒ" onerror="this.onerror=null;this.src='https://via.placeholder.com/40/cccccc/000000?text=${colleague.name[0]}';">
                        <div class="contact-info">
                            <span class="contact-name">${colleague.name}</span>
                            <span class="contact-status-text">${colleague.role}</span>
                        </div>
                        <div class="status-dot ${statusClass}" title="${statusText}"></div>
                    </div>
                `;
            }).join('');
        }

        function renderHeaderShortcuts() {
            if (!headerShortcutsContainer) return;

            headerShortcutsContainer.innerHTML = '';
            HEADER_SHORTCUTS.forEach(shortcut => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'shortcut-chip';
                button.textContent = shortcut.label;
                button.title = `${shortcut.label} (${shortcut.code})`;
                button.addEventListener('click', () => useCommand(shortcut.code));
                headerShortcutsContainer.appendChild(button);

                if (shortcutSelectEl) {
                    const option = document.createElement('option');
                    option.value = shortcut.code;
                    option.textContent = shortcut.label;
                    shortcutSelectEl.appendChild(option);
                }
            });

            if (shortcutSelectEl) {
                shortcutSelectEl.addEventListener('change', (event) => {
                    const value = event.target.value;
                    if (value) {
                        useCommand(value);
                    }
                });
            }
        }

        window.startChatWithColleague = function (name) {
            console.log(`æ­£åœ¨æ¨¡æ‹Ÿå¯åŠ¨ä¸ ${name} çš„ç§èŠçª—å£...`);
            displayMessage('bot', `æ‚¨å¥½ï¼Œä¼ä¸šæ™ºèƒ½åŠ©æ‰‹ç›®å‰å¤„äºä¸»æ¨¡å¼ã€‚å¦‚éœ€ä¸ **${name}** æ²Ÿé€šï¼Œè¯·åˆ‡æ¢åˆ°ç§èŠæ¨¡å¼ã€‚`);
        };

        window.useCommand = function (command) {
            if (!command) return;
            inputEl.value = command.trim() + ' ';
            inputEl.focus();
            if (shortcutSelectEl) {
                shortcutSelectEl.value = '';
            }
        };

        // å¤„ç†ä¼ä¸šåŠŸèƒ½æ¨¡å—ç‚¹å‡»
        window.openFeature = function (featureType) {
            const featureMessages = {
                'project': 'æŸ¥çœ‹é¡¹ç›®æ–‡ä»¶åº“',
                'meeting': 'é¢„å®šä¼šè®®',
                'resource': 'æŸ¥çœ‹èµ„æºå…±äº«'
            };
            
            const query = featureMessages[featureType] || `æ‰“å¼€${featureType}åŠŸèƒ½`;
            
            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯å¹¶å‘é€æŸ¥è¯¢
            displayMessage('user', query, userAvatar, getCurrentTime());
            setTimeout(() => {
                fetch('/send_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: query })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.answer) {
                        displayMessage('bot', data.answer, botAvatar, getCurrentTime());
                    } else {
                        // å¦‚æœæ˜¯æ–°åŠŸèƒ½ï¼Œæä¾›å‹å¥½çš„å“åº”
                        const responses = {
                            'project': 'é¡¹ç›®æ–‡ä»¶åº“åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡èŠå¤©å‘Šè¯‰æˆ‘éœ€è¦æŸ¥çœ‹å“ªä¸ªé¡¹ç›®çš„æ–‡ä»¶ï¼Œæˆ‘ä¼šå¸®æ‚¨æŸ¥æ‰¾ç›¸å…³ä¿¡æ¯ã€‚',
                            'meeting': 'ä¼šè®®é¢„å®šåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡èŠå¤©å‘Šè¯‰æˆ‘ä¼šè®®æ—¶é—´å’Œå‚ä¼šäººå‘˜ï¼Œæˆ‘ä¼šå¸®æ‚¨å®‰æ’ã€‚',
                            'resource': 'èµ„æºå…±äº«åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ã€‚æ‚¨å¯ä»¥é€šè¿‡èŠå¤©åˆ†äº«èµ„æºé“¾æ¥æˆ–æ–‡æ¡£ï¼Œæˆ‘ä¼šå¸®æ‚¨æ•´ç†ã€‚'
                        };
                        displayMessage('bot', responses[featureType] || 'è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼', botAvatar, getCurrentTime());
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    displayMessage('bot', 'æŠ±æ­‰ï¼Œå¤„ç†è¯·æ±‚æ—¶å‡ºç°é”™è¯¯ã€‚', botAvatar, getCurrentTime());
                });
            }, 300);
        };

        window.handleMediaInput = function (type) {
            const message = `[ç³»ç»Ÿæç¤º] æ‚¨å°è¯•å‘é€ä¸€ä¸ª**${type === 'emoji' ? 'è¡¨æƒ…åŒ…' : type === 'image' ? 'å›¾ç‰‡' : 'è¯­éŸ³'}**ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶é€‰æ‹©å™¨æˆ–å½•éŸ³ç•Œé¢ã€‚`;
            displayMessage('user', `å‘é€ ${type}...`);
            displayMessage('bot', message);
        };

        window.prepareAndSendMessage = function () {
            const userMessage = inputEl.value.trim();
            if (userMessage === '') return;

            btnEl.disabled = true;

            const quickUrl = detectQuickCommand(userMessage);
            if (quickUrl) {
                displayMessage('user', userMessage);
                inputEl.value = '';

                setTimeout(() => {
                    displayMessage('bot', `æ­£åœ¨ä¸ºæ‚¨æ‰“å¼€ **${userMessage.replace(/@/g, '')}** ç›¸å…³çš„å·¥å…·é¡µé¢... <a href="${quickUrl}" target="_blank" class="bot-link">ç‚¹å‡»æ‰“å¼€</a>`);
                    btnEl.disabled = false;
                }, 500);

                return;
            }

            sendMessageToAPI(userMessage);
        };

        function sendMessageToAPI(userMessage) {
            const prevIcon = btnEl.innerHTML;
            btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            showTyping();

            fetch('/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: userMessage }),
            })
            .then(response => response.json())
            .then(data => {
                hideTyping();
                btnEl.disabled = false;
                btnEl.innerHTML = prevIcon;

                if (data.answer) {
                    displayMessage('bot', data.answer, botAvatar, getCurrentTime());
                } else {
                    displayMessage('bot', 'æŠ±æ­‰,å¤„ç†æ‚¨çš„è¯·æ±‚æ—¶å‡ºç°äº†é”™è¯¯ã€‚', botAvatar, getCurrentTime());
                }
            })
            .catch(error => {
                console.error('è¯·æ±‚å‡ºé”™:', error);
                hideTyping();
                btnEl.disabled = false;
                btnEl.innerHTML = prevIcon;
                displayMessage('bot', 'æŠ±æ­‰,ç½‘ç»œæˆ–æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚', botAvatar, getCurrentTime());
            });
        }

        function displayInitialMessage() {
            addMessage('bot', 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¼ä¸šæ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡', botAvatar, getCurrentTime());
        }

        inputEl.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                prepareAndSendMessage();
            }
        });

        document.addEventListener('click', function (e) {
            if (e.target.classList && e.target.classList.contains('bot-link')) {
                e.preventDefault();
                window.open(e.target.href, '_blank');
            }
        }, true);

        renderColleagues();
        renderHeaderShortcuts();
        displayInitialMessage();
        inputEl.focus();
    </script>
</body>
</html>